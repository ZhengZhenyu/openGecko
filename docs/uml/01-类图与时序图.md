# openGecko - UML 设计文档

**文档版本**: v3.0
**更新日期**: 2026-02-21
**UML 工具**: Mermaid（文本格式）

> **变更说明**: 基于 Phase 1-3 实际交付代码全量更新。新增治理域类图、密码重置时序、会议管理时序；更新领域模型（16 张表）、服务层（移除 APScheduler，新增 ICS/Notification）、前端组件图（23 个视图）、用例图（含治理模块）。

---

## 1. 领域模型类图 — 核心域

```mermaid
classDiagram
    class User {
        +int id
        +string username
        +string email
        +string hashed_password
        +boolean is_active
        +boolean is_superuser
        +boolean is_default_admin
        +datetime created_at
        +datetime updated_at
    }

    class Community {
        +int id
        +string name
        +string slug
        +string description
        +string logo_url
        +string url
        +boolean is_active
        +json settings
        +datetime created_at
        +datetime updated_at
    }

    class CommunityUser {
        +int id
        +int community_id
        +int user_id
        +string role
        +datetime joined_at
    }

    class Content {
        +int id
        +int community_id
        +int created_by_user_id
        +int owner_id
        +string title
        +string summary
        +text content
        +string status
        +string work_status
        +string category
        +json tags
        +string cover_image
        +datetime scheduled_at
        +datetime created_at
        +datetime updated_at
    }

    class ContentCollaborator {
        +int id
        +int content_id
        +int user_id
        +datetime added_at
    }

    class ContentAssignee {
        +int id
        +int content_id
        +int user_id
        +datetime assigned_at
    }

    class PublishRecord {
        +int id
        +int content_id
        +int community_id
        +string channel
        +string status
        +string wechat_media_id
        +string external_url
        +string error_message
        +datetime published_at
        +datetime created_at
    }

    class ChannelConfig {
        +int id
        +int community_id
        +string channel
        +string credentials_encrypted
        +boolean is_active
        +datetime created_at
        +datetime updated_at
    }

    class AuditLog {
        +int id
        +int community_id
        +int user_id
        +string action
        +string resource_type
        +int resource_id
        +json details
        +string ip_address
        +datetime created_at
    }

    class PasswordResetToken {
        +int id
        +int user_id
        +string token
        +datetime expires_at
        +boolean used
        +datetime created_at
        +is_expired() bool
        +is_valid() bool
    }

    %% 关系
    Community "1" --> "*" CommunityUser : has
    User "1" --> "*" CommunityUser : belongs_to
    Community "1" --> "*" Content : contains
    Community "1" --> "*" ChannelConfig : configures
    Community "1" --> "*" AuditLog : records
    User "1" --> "*" Content : creates
    User "1" --> "*" Content : owns
    Content "1" --> "*" ContentCollaborator : has
    Content "1" --> "*" ContentAssignee : assigns
    Content "1" --> "*" PublishRecord : published_via
    User "1" --> "*" PasswordResetToken : has
```

---

## 2. 领域模型类图 — 治理域

```mermaid
classDiagram
    class Community {
        +int id
        +string name
        +string slug
    }

    class User {
        +int id
        +string username
        +string email
    }

    class Committee {
        +int id
        +int community_id
        +string name
        +string slug
        +string description
        +string purpose
        +boolean is_active
        +datetime created_at
        +datetime updated_at
    }

    class CommitteeMember {
        +int id
        +int committee_id
        +int user_id
        +string role
        +string title
        +datetime joined_at
        +datetime left_at
        +boolean is_active
    }

    class Meeting {
        +int id
        +int community_id
        +int committee_id
        +int created_by_user_id
        +string title
        +string description
        +string meeting_type
        +string status
        +datetime scheduled_at
        +int duration_minutes
        +string location
        +string meeting_url
        +text agenda
        +text minutes
        +datetime created_at
        +datetime updated_at
    }

    class MeetingAssignee {
        +int id
        +int meeting_id
        +int user_id
        +datetime assigned_at
    }

    class MeetingReminder {
        +int id
        +int meeting_id
        +datetime remind_at
        +boolean sent
        +datetime created_at
    }

    class MeetingParticipant {
        +int id
        +int meeting_id
        +int user_id
        +datetime joined_at
    }

    %% 关系
    Community "1" --> "*" Committee : has
    Community "1" --> "*" Meeting : hosts
    Committee "1" --> "*" CommitteeMember : has
    Committee "1" --> "*" Meeting : schedules
    User "1" --> "*" CommitteeMember : serves_as
    User "1" --> "*" Meeting : creates
    Meeting "1" --> "*" MeetingAssignee : assigns
    Meeting "1" --> "*" MeetingReminder : reminds
    Meeting "1" --> "*" MeetingParticipant : includes
    User "1" --> "*" MeetingAssignee : assigned_to
    User "1" --> "*" MeetingParticipant : attends
```

---

## 3. 核心服务类图

```mermaid
classDiagram
    class AuthService {
        -pwd_context CryptContext
        -secret_key string
        +login(username, password) Token
        +verify_token(token) User
        +create_access_token(user_id) string
        +hash_password(password) string
    }

    class ConverterService {
        +convert_docx_to_markdown(file_path) tuple
        +convert_markdown_to_html(markdown) string
        +extract_images(docx_path) list
    }

    class WeChatService {
        -app_id string
        -app_secret string
        +get_access_token() string
        +upload_image(image_path) string
        +upload_thumb_media(image_path) string
        +convert_to_wechat_html(markdown) string
        +create_draft(title, content, thumb_id) dict
    }

    class HugoService {
        +generate_front_matter(content) string
        +generate_post(content) string
    }

    class CSDNService {
        +format_for_csdn(content) dict
    }

    class ZhihuService {
        +format_for_zhihu(content) dict
    }

    class ICSService {
        +generate_ics(meeting) bytes
        +format_event(meeting) dict
    }

    class EmailService {
        -smtp_host string
        -smtp_port int
        +send_password_reset(email, token) bool
        +send_notification(email, subject, body) bool
    }

    class NotificationService {
        +notify_content_assignee(content, user, db) void
        +notify_meeting_assignee(meeting, user, db) void
    }

    %% 依赖
    NotificationService ..> EmailService : uses
    WeChatService ..> ConverterService : uses (html conversion)
```

---

## 4. 用户登录时序图

```mermaid
sequenceDiagram
    participant User as 用户
    participant Frontend as 前端(Vue)
    participant AuthStore as Pinia Store
    participant API as FastAPI
    participant DB as 数据库

    User->>Frontend: 输入用户名密码
    Frontend->>API: POST /api/auth/login {username, password}

    API->>DB: SELECT * FROM users WHERE username=?
    DB-->>API: User record
    API->>API: verify_password(password, hashed)

    alt 密码正确
        API->>API: create_access_token(user_id)
        API-->>Frontend: 200 {access_token}
        Frontend->>AuthStore: setToken(access_token)
        Frontend->>API: GET /api/auth/me  Authorization: Bearer
        API->>DB: SELECT user + community_users JOIN communities
        DB-->>API: User + Communities
        API-->>Frontend: 200 {user, communities}
        Frontend->>AuthStore: setUser(user, communities)
        Frontend->>User: 跳转到工作台
    else 密码错误
        API-->>Frontend: 401 {detail: "用户名或密码错误"}
        Frontend->>User: 显示错误提示
    end
```

---

## 5. 密码重置时序图

```mermaid
sequenceDiagram
    participant User as 用户
    participant Frontend as 前端
    participant API as FastAPI
    participant EmailSvc as EmailService
    participant DB as 数据库
    participant SMTP as SMTP 服务器

    User->>Frontend: 输入注册邮箱
    Frontend->>API: POST /api/auth/forgot-password {email}
    API->>DB: SELECT user WHERE email=?
    DB-->>API: User record (or null)

    note over API: 无论账号是否存在，均返回 200（防止枚举攻击）
    API->>API: generate_reset_token()
    API->>DB: INSERT password_reset_tokens (user_id, token, expires_at)
    API->>EmailSvc: send_password_reset(email, token)
    EmailSvc->>SMTP: SMTP 发送重置邮件
    API-->>Frontend: 200 {message: "邮件已发送"}
    Frontend->>User: 提示查收邮件

    User->>Frontend: 点击邮件中的重置链接
    Frontend->>API: POST /api/auth/reset-password {token, new_password}
    API->>DB: SELECT token WHERE token=? AND used=false
    DB-->>API: PasswordResetToken

    alt token 有效且未过期
        API->>API: hash_password(new_password)
        API->>DB: UPDATE users SET hashed_password=?
        API->>DB: UPDATE password_reset_tokens SET used=true
        API-->>Frontend: 200 {message: "密码重置成功"}
        Frontend->>User: 跳转登录页
    else token 无效或已过期
        API-->>Frontend: 400 {detail: "重置链接已失效"}
        Frontend->>User: 显示错误提示
    end
```

---

## 6. 社区切换时序图

```mermaid
sequenceDiagram
    participant User as 用户
    participant Switcher as CommunitySwitcher 组件
    participant Store as Community Store
    participant ContentList as 内容列表组件
    participant API as FastAPI

    User->>Switcher: 选择社区(ID=5)
    Switcher->>Store: setCommunity(5)
    Store->>Store: localStorage.setItem('currentCommunityId', 5)
    Store->>Store: 触发 reactivity 更新

    ContentList->>ContentList: watch(communityId) 触发
    ContentList->>API: GET /api/contents  X-Community-Id: 5
    API->>API: get_current_community() → 5
    API->>DB: SELECT * FROM contents WHERE community_id=5
    DB-->>API: Filtered data
    API-->>ContentList: 200 {items: [...]}
    ContentList->>User: 刷新列表显示
```

---

## 7. 内容发布到微信时序图

```mermaid
sequenceDiagram
    participant User as 用户
    participant Frontend as 前端
    participant API as FastAPI
    participant WeChatSvc as WeChatService
    participant WeChatAPI as 微信公众号 API
    participant DB as 数据库

    User->>Frontend: 点击"发布到微信"
    Frontend->>API: POST /api/publish/{content_id}/wechat  X-Community-Id

    API->>DB: SELECT content WHERE id=? AND community_id=?
    DB-->>API: Content record

    alt 无封面图
        API-->>Frontend: 400 {detail: "缺少封面图"}
    else 有封面图
        API->>DB: SELECT channel_config WHERE community_id=? AND channel='wechat'
        DB-->>API: credentials_encrypted
        API->>API: Fernet 解密凭证

        API->>WeChatSvc: upload_thumb_media(cover_image)
        WeChatSvc->>WeChatAPI: POST /cgi-bin/material/add_material
        WeChatAPI-->>WeChatSvc: {media_id}

        API->>WeChatSvc: convert_to_wechat_html(markdown)
        WeChatSvc-->>API: HTML with inline styles

        API->>WeChatSvc: create_draft(title, html, thumb_id)
        WeChatSvc->>WeChatAPI: POST /cgi-bin/draft/add
        WeChatAPI-->>WeChatSvc: {media_id}

        API->>DB: INSERT publish_records (status='published', wechat_media_id)
        API->>DB: INSERT audit_logs (action='publish_to_wechat')
        API-->>Frontend: 200 {message: "已推送为草稿"}
        Frontend->>User: 提示前往公众号后台确认发布
    end
```

---

## 8. 日历视图拖拽排期时序图

```mermaid
sequenceDiagram
    participant User as 用户
    participant Calendar as FullCalendar 组件
    participant Frontend as ContentCalendar.vue
    participant API as FastAPI
    participant DB as 数据库

    User->>Calendar: 拖拽内容事件到 2026-03-15
    Calendar->>Frontend: eventDrop(event)
    Frontend->>API: PATCH /api/contents/{id}  {scheduled_at: "2026-03-15"}

    API->>DB: UPDATE contents SET scheduled_at=? WHERE id=? AND community_id=?
    DB-->>API: 1 row affected
    API->>DB: INSERT audit_logs (action='schedule_content')
    API-->>Frontend: 200 Content

    alt 更新成功
        Frontend->>Calendar: event.setProp('start', newDate)
        Frontend->>User: ElMessage.success("发布时间已更新")
    else 更新失败
        Frontend->>Calendar: event.revert()
        Frontend->>User: ElMessage.error("更新失败")
    end
```

---

## 9. 内容状态流转时序图（看板拖拽）

```mermaid
sequenceDiagram
    participant User as 用户
    participant Kanban as ContentKanban.vue
    participant API as FastAPI
    participant DB as 数据库

    User->>Kanban: 将卡片从 draft 拖到 reviewing
    Kanban->>API: PATCH /api/contents/{id}  {status: "reviewing"}

    API->>API: validate_status_transition(old, new)

    alt 流转合法
        API->>DB: UPDATE contents SET status='reviewing' WHERE id=? AND community_id=?
        API->>DB: INSERT audit_logs (action='change_status')
        API-->>Kanban: 200 Content
        Kanban->>User: ElMessage.success("已移至审核中")
    else 流转非法
        API-->>Kanban: 422 {detail: "不允许的状态流转"}
        Kanban->>Kanban: 重新加载看板数据（回滚 UI）
        Kanban->>User: ElMessage.error("状态更新失败")
    end
```

---

## 10. 会议管理与 ICS 导出时序图

```mermaid
sequenceDiagram
    participant User as 用户
    participant Frontend as MeetingList.vue
    participant API as FastAPI
    participant ICSSvc as ICSService
    participant DB as 数据库

    User->>Frontend: 创建会议
    Frontend->>API: POST /api/committees/{cid}/meetings  {title, scheduled_at, ...}
    API->>DB: INSERT meetings (committee_id, community_id, ...)
    API->>DB: INSERT audit_logs
    API-->>Frontend: 201 Meeting
    Frontend->>User: 会议创建成功

    User->>Frontend: 点击"导出 ICS"
    Frontend->>API: GET /api/committees/{cid}/meetings/{id}/ics
    API->>DB: SELECT meeting WHERE id=?
    DB-->>API: Meeting record
    API->>ICSSvc: generate_ics(meeting)
    ICSSvc-->>API: bytes (iCalendar 格式)
    API-->>Frontend: 200 application/octet-stream
    Frontend->>User: 下载 .ics 文件（可导入日历 App）
```

---

## 11. 状态机图 — 内容状态流转

```mermaid
stateDiagram-v2
    [*] --> draft : 创建内容 / 上传文档

    draft --> reviewing : 提交审核
    reviewing --> approved : 审核通过
    reviewing --> draft : 审核退回

    approved --> published : 确认发布
    approved --> draft : 退回修改

    published --> [*] : 归档（仅查看）

    note right of draft
        草稿：可编辑、可删除
    end note
    note right of reviewing
        审核中：锁定编辑
    end note
    note right of approved
        已通过：等待发布
    end note
    note right of published
        已发布：只读
    end note
```

**状态转换规则**:

| 当前状态 | 允许流转到 | 禁止流转到 |
|---------|-----------|-----------|
| draft | reviewing | approved, published |
| reviewing | approved, draft | published |
| approved | published, draft | reviewing |
| published | — | draft, reviewing, approved |

---

## 12. 活动图 — DOCX 文件上传处理

```mermaid
flowchart TD
    Start([用户上传 DOCX 文件]) --> Validate{验证文件}

    Validate -->|格式不支持| Error1[400: 不支持的文件格式]
    Validate -->|超过 10MB| Error2[400: 文件过大]
    Validate -->|通过| GenFilename[生成随机文件名\n防路径穿越]

    GenFilename --> Save[保存到 uploads/ 目录]
    Save --> Extract[mammoth 提取内容\nDOCX → HTML]
    Extract --> ExtractImages{含图片?}

    ExtractImages -->|有| SaveImages[保存图片到 uploads/images/]
    SaveImages --> ReplaceURL[替换图片 URL]
    ReplaceURL --> ConvertMD[html2text → Markdown]

    ExtractImages -->|无| ConvertMD

    ConvertMD --> CreateRecord[INSERT contents\ncommunity_id 来自 X-Community-Id\ncreated_by/owner = 当前用户]
    CreateRecord --> AuditLog[INSERT audit_logs\naction='upload_docx']
    AuditLog --> Success[201 Created Content]

    Error1 --> End([结束])
    Error2 --> End
    Success --> End
```

---

## 13. 部署图

```mermaid
graph TB
    subgraph "用户设备"
        Browser[Web 浏览器]
    end

    subgraph "Docker 主机"
        subgraph "Frontend 容器"
            Nginx[Nginx 静态服务]
            VueApp[Vue 3 SPA]
        end

        subgraph "Backend 容器"
            Uvicorn[Uvicorn ASGI]
            FastAPI[FastAPI Python 3.11]
        end

        subgraph "Database"
            SQLite[(SQLite\n开发)]
            Postgres[(PostgreSQL 15\n生产)]
        end

        subgraph "存储卷"
            Uploads[/uploads\n文档 + 图片]
        end
    end

    subgraph "外部服务"
        WeChatAPI[微信公众号 API]
        HugoRepo[Hugo Git 仓库]
        SMTP[SMTP 邮件服务]
    end

    Browser -->|HTTPS :443| Nginx
    Nginx -->|/api proxy :8000| Uvicorn
    FastAPI -->|SQLAlchemy ORM| Postgres
    FastAPI -->|文件读写| Uploads
    FastAPI -->|HTTPS| WeChatAPI
    FastAPI -->|Git Push| HugoRepo
    FastAPI -->|SMTP| SMTP
```

---

## 14. 包图

```mermaid
graph TB
    subgraph "Frontend"
        Views[Views\n23 个页面组件]
        Components[Components\nCommunitySwitcher / RoleBadge / MemberCard]
        Stores[Stores\nauth / community / user]
        APIClient[API\n8 个 Axios 模块]
        Router[Router\nVue Router + 路由守卫]
    end

    subgraph "Backend"
        APIRouters[api/\n10 个 FastAPI 路由]
        Services[services/\nwechat / hugo / csdn / zhihu\nconverter / ics / email / notification]
        Models[models/\n16 张 SQLAlchemy 表]
        Schemas[schemas/\nPydantic 请求/响应模型]
        Core[core/\nJWT / bcrypt / Fernet / dependencies]
    end

    Views --> APIClient
    Views --> Stores
    APIClient --> APIRouters
    APIRouters --> Services
    APIRouters --> Core
    Services --> Models
    APIRouters --> Schemas
    Schemas --> Models
```

---

## 15. 前端组件图

```mermaid
graph LR
    App[App.vue] --> CommunitySwitcher
    App --> RouterView[router-view]

    RouterView --> Auth[LoginView\nForgotPasswordView\nResetPasswordView\nInitSetupView]
    RouterView --> Community[CommunityList\nCommunityDetail\nCommunityDashboard]
    RouterView --> Content[ContentList\nContentDetail\nContentCreate\nContentEdit\nContentCalendar\nContentKanban]
    RouterView --> Publish[PublishView]
    RouterView --> Governance[CommitteeList\nCommitteeDetail\nMeetingList\nMeetingDetail]
    RouterView --> Personal[MyWork\nWorkloadOverview]
    RouterView --> Admin[UserManagement\nAuditLogs]

    ContentCalendar --> FullCalendar[FullCalendar]
    ContentEdit --> MdEditor[md-editor-v3]
    ContentKanban --> VueDraggable[vue-draggable-plus]
    CommunityDashboard --> ECharts[ECharts]
```

---

## 16. 用例图

```mermaid
graph TB
    subgraph "openGecko 系统"
        subgraph "认证与账号"
            UC1[登录系统]
            UC2[重置密码]
            UC3[切换社区]
        end

        subgraph "内容管理"
            UC4[创建/编辑内容]
            UC5[上传 DOCX]
            UC6[内容日历排期]
            UC7[看板状态管理]
            UC8[发布到微信/Hugo/CSDN/知乎]
        end

        subgraph "社区治理"
            UC9[管理委员会]
            UC10[管理委员会成员]
            UC11[管理会议]
            UC12[导出会议 ICS]
        end

        subgraph "工作台"
            UC13[个人工作台]
            UC14[社区总览仪表板]
            UC15[工作量总览]
        end

        subgraph "管理（Admin+）"
            UC16[社区管理]
            UC17[成员管理]
            UC18[渠道配置]
            UC19[用户管理]
            UC20[审计日志]
        end
    end

    UserRole[社区成员 user]
    AdminRole[社区管理员 admin]
    SuperRole[超级管理员 superuser]

    UserRole --> UC1 & UC2 & UC3
    UserRole --> UC4 & UC5 & UC6 & UC7 & UC8
    UserRole --> UC9 & UC10 & UC11 & UC12
    UserRole --> UC13 & UC14

    AdminRole --> UC16 & UC17 & UC18

    SuperRole --> UC19 & UC20 & UC15

    style UserRole fill:#cce5ff
    style AdminRole fill:#fff3cd
    style SuperRole fill:#ffcccc
```

---

## 17. 对象图 — 多社区运行时实例

```mermaid
graph TB
    subgraph "运行时对象实例"
        C1[community:Community\nid=1 name='Kubernetes']
        C2[community:Community\nid=2 name='Prometheus']

        U1[user:User\nid=5 username='zhangsan'\nis_superuser=false]
        U2[user:User\nid=1 username='admin'\nis_superuser=true]

        CU1[communityUser\nuser_id=5 community_id=1\nrole='admin']
        CU2[communityUser\nuser_id=5 community_id=2\nrole='user']

        Ct1[content:Content\nid=123 community_id=1\nstatus='published']
        Ct2[content:Content\nid=124 community_id=2\nstatus='draft']

        PR1[publishRecord\ncontent_id=123\nchannel='wechat' status='published']

        Cm1[committee:Committee\ncommunity_id=1\nname='技术委员会']

        Mtg1[meeting:Meeting\ncommunity_id=1\ncommittee_id=Cm1\nstatus='scheduled']

        Cfg1[channelConfig\ncommunity_id=1\nchannel='wechat'\ncredentials_encrypted=...]
        Cfg2[channelConfig\ncommunity_id=2\nchannel='hugo'\ncredentials_encrypted=...]
    end

    C1 --> Ct1 & Cm1 & Cfg1
    C2 --> Ct2 & Cfg2
    U1 --> CU1 & CU2
    CU1 --> C1
    CU2 --> C2
    Ct1 --> PR1
    Cm1 --> Mtg1
```

**说明**：此图展示多租户运行时实例关系：
- 用户 zhangsan 同时属于 2 个社区（不同角色）
- 每个社区有独立的内容、委员会、渠道配置
- 超级管理员 admin 拥有跨社区访问权限
- 委员会与会议归属单一社区，数据完全隔离

---

## 附录：Mermaid 渲染工具

本文档使用 Mermaid 文本格式，可在以下工具中渲染：
- GitHub / GitLab（原生支持）
- VS Code 插件：Markdown Preview Mermaid Support
- 在线工具：https://mermaid.live/
- Obsidian、Typora 等 Markdown 编辑器
