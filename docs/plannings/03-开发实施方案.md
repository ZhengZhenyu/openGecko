# openGecko — 分步开发实施方案

**关联需求文档**: [02-新模块需求分析.md](../requirements/02-新模块需求分析.md)（v2.0）
**文档版本**: v1.0
**更新日期**: 2026-02-22

> 本文档以当前代码库现状为基准，逐阶段给出**精确到文件/函数/SQL**的开发指令，可直接按顺序执行。

---

## 目录

1. [代码库现状速查](#1-代码库现状速查)
2. [前置重构阶段](#2-前置重构阶段)
   - 2.1 [权限模型简化](#21-权限模型简化移除-community_admin)
   - 2.2 [内容多社区关联](#22-内容多社区关联-content_communities)
   - 2.3 [前端导航重组](#23-前端导航重组)
3. [Phase 4a — 人脉中台 + 活动管理基础](#3-phase-4a--人脉中台--活动管理基础)
   - 3.1 [PersonProfile + CommunityRole 模型](#31-personprofile--communityrole-模型)
   - 3.2 [CommitteeMember 关联 PersonProfile](#32-committeemember-关联-personprofile)
   - 3.3 [Event + SOP 模板 + Checklist 模型](#33-event--sop-模板--checklist-模型)
   - 3.4 [后端 API 实现](#34-后端-api-实现)
   - 3.5 [签到名单导入服务](#35-签到名单导入服务)
   - 3.6 [前端页面](#36-前端页面)
4. [Phase 4b — 甘特图 + 反馈 Issue 关联](#4-phase-4b--甘特图--反馈-issue-关联)
5. [Phase 4c — Campaign](#5-phase-4c--campaign)
6. [Phase 4d — 生态洞察](#6-phase-4d--生态洞察)
7. [测试策略](#7-测试策略)



### 1.1 后端已有模块

| 文件 | 说明 | 重构影响 |
|------|------|---------|
| `models/user.py` | `User` + `community_users` 表 | `community_users.role` 注释已写 `'admin', 'user'`，实际数据中可能存在 `community_admin` 值 |
| `models/content.py` | `Content`，含 `community_id` 直接外键 | **需改造**：移除 `community_id`，新增 `content_communities` 关联表 |
| `models/committee.py` | `Committee` + `CommitteeMember` | `CommitteeMember` 已有 `github_id` 字段，**需新增** `person_id` |
| `core/dependencies.py` | 认证依赖注入 | 已有 `get_community_admin`（需保留兼容）+ `get_current_active_superuser` |
| `api/contents.py` | 内容 CRUD | `community_id` 单值过滤需改为 `content_communities` JOIN |
| `api/dashboard.py` | 个人工作台 | 内容统计查询需同步更新 |

### 1.2 数据库迁移现状

当前仅有 `alembic/versions/001_initial.py`，所有新迁移从 `002_` 开始编号。

### 1.3 前端已有视图

```
MyWork.vue          → 个人工作看板（需扩展）
ContentList.vue     → 内容列表（社区选择需改多选）
CommitteeDetail.vue → 委员会详情（成员需加 PersonProfile 关联入口）
Dashboard.vue       → 个人统计（需新增活动/Campaign 卡片）
```

---

## 2. 前置重构阶段

### 2.1 权限模型简化（移除 community_admin）

#### 2.1.1 数据库迁移

新建 `backend/alembic/versions/002_simplify_roles.py`：

```python
"""简化权限模型：移除 community_admin 角色

Revision ID: 002
Revises: 001
"""
from alembic import op

revision = "002"
down_revision = "001"
branch_labels = None
depends_on = None


def upgrade() -> None:
    # 第一步：将所有 community_admin 降级为 user
    op.execute(
        "UPDATE community_users SET role = 'user' WHERE role = 'community_admin'"
    )


def downgrade() -> None:
    # 降级不恢复（无法区分哪些 user 原本是 community_admin）
    pass
```

#### 2.1.2 修改 `core/dependencies.py`

**删除** `get_community_admin` 函数，**新增** `get_current_admin_or_superuser`：

```python
async def get_current_admin_or_superuser(
    current_user: User = Depends(get_current_user),
    db: Session = Depends(get_db),
) -> User:
    """管理员（admin）或超级管理员（superuser）可通过。"""
    if current_user.is_superuser:
        return current_user
    # 检查 community_users 表中是否有任意社区的 admin 角色
    stmt = select(community_users.c.role).where(
        community_users.c.user_id == current_user.id,
        community_users.c.role == "admin",
    ).limit(1)
    result = db.execute(stmt).scalar()
    if not result:
        raise HTTPException(
            status_code=status.HTTP_403_FORBIDDEN,
            detail="管理员权限不足",
        )
    return current_user
```

> **注意**：现有所有使用 `get_community_admin` 的路由需批量替换为 `get_current_admin_or_superuser`。用 `grep -r "get_community_admin" backend/app/api/` 找到全部引用。

#### 2.1.3 `check_content_edit_permission` 更新

`dependencies.py` 中 `check_content_edit_permission` 函数内引用了 `content.community_id`，**在 §2.2 内容迁移完成后**再删除该引用，当前保持兼容。

---

### 2.2 内容多社区关联（content_communities）

#### 2.2.1 数据库迁移（两步策略）

**第一步** — `003_add_content_communities.py`（新增关联表，迁移数据）：

```python
"""新增 content_communities 关联表

Revision ID: 003
Revises: 002
"""
import sqlalchemy as sa
from alembic import op

revision = "003"
down_revision = "002"


def upgrade() -> None:
    op.create_table(
        "content_communities",
        sa.Column("id", sa.Integer, primary_key=True),
        sa.Column("content_id", sa.Integer,
                  sa.ForeignKey("contents.id", ondelete="CASCADE"),
                  nullable=False, index=True),
        sa.Column("community_id", sa.Integer,
                  sa.ForeignKey("communities.id", ondelete="CASCADE"),
                  nullable=False, index=True),
        sa.Column("is_primary", sa.Boolean, default=True),
        sa.Column("linked_at", sa.DateTime, server_default=sa.func.now()),
        sa.Column("linked_by_id", sa.Integer,
                  sa.ForeignKey("users.id", ondelete="SET NULL"),
                  nullable=True),
    )
    op.create_unique_constraint(
        "uq_content_community",
        "content_communities",
        ["content_id", "community_id"],
    )
    # 迁移现有数据：将 contents.community_id 迁入新表
    op.execute("""
        INSERT INTO content_communities (content_id, community_id, is_primary)
        SELECT id, community_id, 1
        FROM contents
        WHERE community_id IS NOT NULL
    """)


def downgrade() -> None:
    op.drop_table("content_communities")
```

**第二步** — `009_remove_content_community_id.py`（迁移验证无误后再执行）：

```python
"""移除 contents.community_id 旧字段

Revision ID: 009
Revises: 008
"""
from alembic import op

revision = "009"
down_revision = "008"


def upgrade() -> None:
    # SQLite 需要 batch_alter_table；PostgreSQL 可直接 drop
    with op.batch_alter_table("contents") as batch_op:
        batch_op.drop_constraint("fk_contents_community_id", type_="foreignkey")
        batch_op.drop_column("community_id")


def downgrade() -> None:
    with op.batch_alter_table("contents") as batch_op:
        batch_op.add_column(
            sa.Column("community_id", sa.Integer, nullable=True)
        )
```

#### 2.2.2 修改 `models/content.py`

在现有 `Content` 类末尾追加关联表定义和 relationship，**暂时保留** `community_id` 字段（兼容过渡）：

```python
# 新增关联表（在 content_collaborators 定义之后）
content_communities = Table(
    "content_communities",
    Base.metadata,
    Column("id", Integer, primary_key=True),
    Column("content_id", Integer,
           ForeignKey("contents.id", ondelete="CASCADE"),
           nullable=False, index=True),
    Column("community_id", Integer,
           ForeignKey("communities.id", ondelete="CASCADE"),
           nullable=False, index=True),
    Column("is_primary", Boolean, default=True),
    Column("linked_at", DateTime, default=datetime.utcnow),
    Column("linked_by_id", Integer,
           ForeignKey("users.id", ondelete="SET NULL"),
           nullable=True),
)

# Content 类中新增 relationship（保留旧 community relationship 作兼容）
communities = relationship(
    "Community",
    secondary="content_communities",
    back_populates="linked_contents",
)
```

在 `models/community.py` 的 `Community` 类中追加：

```python
linked_contents = relationship(
    "Content",
    secondary="content_communities",
    back_populates="communities",
)
```

#### 2.2.3 修改 `schemas/content.py`

```python
# ContentCreate 新增
community_ids: list[int] = []   # 替代原 community_id（创建时关联的社区列表）

# ContentOut 新增
community_ids: list[int] = []
```

#### 2.2.4 修改 `api/contents.py`

关键改动点（搜索 `community_id` 替换）：

```python
# 创建内容时（原来: content.community_id = community_id）
for cid in content_in.community_ids or [community_id]:
    db.execute(
        insert(content_communities).values(
            content_id=new_content.id,
            community_id=cid,
            is_primary=(cid == (content_in.community_ids or [community_id])[0]),
            linked_by_id=current_user.id,
        )
    )

# 列表查询过滤（原来: .filter(Content.community_id == community_id)）
.join(content_communities,
      content_communities.c.content_id == Content.id
).filter(
    content_communities.c.community_id == community_id
)
```

---

### 2.3 前端导航重组

涉及文件：`frontend/src/router/index.ts`、`frontend/src/App.vue` 或侧边栏组件。

导航菜单新结构（按 §5 导航设计）：
1. 个人工作看板 → `/my-work`
2. 社区治理 → `/communities/:id/governance`、`/committees`、`/meetings`
3. 内容管理 → `/contents`
4. 活动管理 → `/events`（新增，Phase 4a 后激活）
5. 洞察与人脉 → `/people`、`/campaigns`（新增，Phase 4a/4c 后激活）
6. 平台管理 → 仅 `is_superuser || role === 'admin'` 可见

> 新模块路由可先注册为空页面占位，功能随 Phase 开发完成后逐步填充。

---

## 3. Phase 4a — 人脉中台 + 活动管理基础

### 3.1 PersonProfile + CommunityRole 模型

新建 `backend/app/models/people.py`：

```python
from datetime import datetime
from sqlalchemy import Boolean, Column, Date, DateTime, ForeignKey, Integer, JSON, String, Text
from sqlalchemy import Enum as SAEnum
from sqlalchemy.orm import relationship
from app.database import Base

class PersonProfile(Base):
    __tablename__ = "person_profiles"

    id = Column(Integer, primary_key=True, index=True)
    display_name = Column(String(200), nullable=False, index=True)
    avatar_url = Column(String(500), nullable=True)
    github_handle = Column(String(100), nullable=True, unique=True, index=True)
    gitcode_handle = Column(String(100), nullable=True, unique=True, index=True)
    email = Column(String(200), nullable=True, unique=True, index=True)
    phone = Column(String(50), nullable=True)
    company = Column(String(200), nullable=True, index=True)
    location = Column(String(200), nullable=True)
    bio = Column(Text, nullable=True)
    tags = Column(JSON, default=list)
    notes = Column(Text, nullable=True)
    source = Column(
        SAEnum("manual", "event_import", "ecosystem_import", name="person_source_enum"),
        nullable=False, default="manual",
    )
    created_by_id = Column(Integer, ForeignKey("users.id", ondelete="SET NULL"), nullable=True)
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)

    community_roles = relationship("CommunityRole", back_populates="person", cascade="all, delete-orphan")
    event_attendances = relationship("EventAttendee", back_populates="person")


class CommunityRole(Base):
    __tablename__ = "community_roles"

    id = Column(Integer, primary_key=True, index=True)
    person_id = Column(Integer, ForeignKey("person_profiles.id", ondelete="CASCADE"), nullable=False, index=True)
    community_name = Column(String(200), nullable=False)
    project_url = Column(String(500), nullable=True)
    role = Column(String(100), nullable=False)
    role_label = Column(String(100), nullable=True)
    is_current = Column(Boolean, default=True)
    started_at = Column(Date, nullable=True)
    ended_at = Column(Date, nullable=True)
    source_url = Column(String(500), nullable=True)
    updated_by_id = Column(Integer, ForeignKey("users.id", ondelete="SET NULL"), nullable=True)

    person = relationship("PersonProfile", back_populates="community_roles")
```

数据库迁移 `004_add_people_module.py`（`down_revision = "003"`）：

```python
def upgrade() -> None:
    op.create_table("person_profiles",
        sa.Column("id", sa.Integer, primary_key=True),
        sa.Column("display_name", sa.String(200), nullable=False),
        sa.Column("avatar_url", sa.String(500)),
        sa.Column("github_handle", sa.String(100), unique=True),
        sa.Column("gitcode_handle", sa.String(100), unique=True),
        sa.Column("email", sa.String(200), unique=True),
        sa.Column("phone", sa.String(50)),
        sa.Column("company", sa.String(200)),
        sa.Column("location", sa.String(200)),
        sa.Column("bio", sa.Text),
        sa.Column("tags", sa.JSON, default=list),
        sa.Column("notes", sa.Text),
        sa.Column("source", sa.String(30), nullable=False, server_default="manual"),
        sa.Column("created_by_id", sa.Integer, sa.ForeignKey("users.id", ondelete="SET NULL")),
        sa.Column("created_at", sa.DateTime, server_default=sa.func.now()),
        sa.Column("updated_at", sa.DateTime, server_default=sa.func.now()),
    )
    op.create_table("community_roles",
        sa.Column("id", sa.Integer, primary_key=True),
        sa.Column("person_id", sa.Integer, sa.ForeignKey("person_profiles.id", ondelete="CASCADE"), nullable=False),
        sa.Column("community_name", sa.String(200), nullable=False),
        sa.Column("project_url", sa.String(500)),
        sa.Column("role", sa.String(100), nullable=False),
        sa.Column("role_label", sa.String(100)),
        sa.Column("is_current", sa.Boolean, server_default="1"),
        sa.Column("started_at", sa.Date),
        sa.Column("ended_at", sa.Date),
        sa.Column("source_url", sa.String(500)),
        sa.Column("updated_by_id", sa.Integer, sa.ForeignKey("users.id", ondelete="SET NULL")),
    )
    op.create_index("ix_community_roles_person_id", "community_roles", ["person_id"])

def downgrade() -> None:
    op.drop_table("community_roles")
    op.drop_table("person_profiles")
```

---

### 3.2 CommitteeMember 关联 PersonProfile

迁移 `008_link_committee_member_to_person.py`（`down_revision = "007"`）：

```python
def upgrade() -> None:
    with op.batch_alter_table("committee_members") as batch_op:
        batch_op.add_column(
            sa.Column("person_id", sa.Integer,
                      sa.ForeignKey("person_profiles.id", ondelete="SET NULL"),
                      nullable=True)
        )
        batch_op.create_index("ix_committee_members_person_id", ["person_id"])

def downgrade() -> None:
    with op.batch_alter_table("committee_members") as batch_op:
        batch_op.drop_index("ix_committee_members_person_id")
        batch_op.drop_column("person_id")
```

`models/committee.py` 的 `CommitteeMember` 类末尾增加：

```python
person_id = Column(Integer, ForeignKey("person_profiles.id", ondelete="SET NULL"), nullable=True, index=True)
person = relationship("PersonProfile", foreign_keys=[person_id])
```

---

### 3.3 Event + SOP 模板 + Checklist 模型

新建 `backend/app/models/event.py`：

```python
from datetime import datetime
from sqlalchemy import Boolean, Column, Date, DateTime, ForeignKey, Integer, JSON, String, Text
from sqlalchemy import Enum as SAEnum
from sqlalchemy.orm import relationship
from app.database import Base

class EventTemplate(Base):
    __tablename__ = "event_templates"
    id = Column(Integer, primary_key=True)
    community_id = Column(Integer, ForeignKey("communities.id", ondelete="CASCADE"), nullable=False, index=True)
    name = Column(String(200), nullable=False)
    event_type = Column(SAEnum("online","offline","hybrid", name="event_type_enum"), nullable=False)
    description = Column(Text)
    is_public = Column(Boolean, default=False)
    created_by_id = Column(Integer, ForeignKey("users.id", ondelete="SET NULL"), nullable=True)
    created_at = Column(DateTime, default=datetime.utcnow)
    checklist_items = relationship("ChecklistTemplateItem", back_populates="template", cascade="all, delete-orphan")
    events = relationship("Event", back_populates="template")

class ChecklistTemplateItem(Base):
    __tablename__ = "checklist_template_items"
    id = Column(Integer, primary_key=True)
    template_id = Column(Integer, ForeignKey("event_templates.id", ondelete="CASCADE"), nullable=False, index=True)
    phase = Column(SAEnum("pre","during","post", name="checklist_phase_enum"), nullable=False)
    title = Column(String(300), nullable=False)
    description = Column(Text)
    order = Column(Integer, default=0)
    template = relationship("EventTemplate", back_populates="checklist_items")

class Event(Base):
    __tablename__ = "events"
    id = Column(Integer, primary_key=True)
    community_id = Column(Integer, ForeignKey("communities.id", ondelete="CASCADE"), nullable=False, index=True)
    title = Column(String(300), nullable=False)
    event_type = Column(SAEnum("online","offline","hybrid", name="event_type_enum2"), nullable=False, default="offline")
    template_id = Column(Integer, ForeignKey("event_templates.id", ondelete="SET NULL"), nullable=True)
    status = Column(
        SAEnum("draft","planning","ongoing","completed","cancelled", name="event_status_enum"),
        default="draft",
    )
    planned_at = Column(DateTime, nullable=True)
    duration_minutes = Column(Integer, nullable=True)
    location = Column(String(300), nullable=True)
    online_url = Column(String(500), nullable=True)
    description = Column(Text)
    cover_image_url = Column(String(500), nullable=True)
    owner_id = Column(Integer, ForeignKey("users.id", ondelete="SET NULL"), nullable=True)
    # 内嵌结果字段
    attendee_count = Column(Integer, nullable=True)
    online_count = Column(Integer, nullable=True)
    offline_count = Column(Integer, nullable=True)
    registration_count = Column(Integer, nullable=True)
    result_summary = Column(Text, nullable=True)
    media_urls = Column(JSON, default=list)
    created_at = Column(DateTime, default=datetime.utcnow)
    updated_at = Column(DateTime, default=datetime.utcnow, onupdate=datetime.utcnow)

    template = relationship("EventTemplate", back_populates="events")
    checklist_items = relationship("ChecklistItem", back_populates="event", cascade="all, delete-orphan")
    personnel = relationship("EventPersonnel", back_populates="event", cascade="all, delete-orphan")
    attendees = relationship("EventAttendee", back_populates="event", cascade="all, delete-orphan")
    feedback_items = relationship("FeedbackItem", back_populates="event", cascade="all, delete-orphan")
    tasks = relationship("EventTask", back_populates="event", cascade="all, delete-orphan")

class ChecklistItem(Base):
    __tablename__ = "checklist_items"
    id = Column(Integer, primary_key=True)
    event_id = Column(Integer, ForeignKey("events.id", ondelete="CASCADE"), nullable=False, index=True)
    phase = Column(SAEnum("pre","during","post", name="checklist_item_phase_enum"), nullable=False)
    title = Column(String(300), nullable=False)
    status = Column(SAEnum("pending","done","skipped", name="checklist_status_enum"), default="pending")
    assignee_id = Column(Integer, ForeignKey("users.id", ondelete="SET NULL"), nullable=True)
    due_date = Column(Date, nullable=True)
    notes = Column(Text)
    order = Column(Integer, default=0)
    event = relationship("Event", back_populates="checklist_items")

class EventPersonnel(Base):
    __tablename__ = "event_personnel"
    id = Column(Integer, primary_key=True)
    event_id = Column(Integer, ForeignKey("events.id", ondelete="CASCADE"), nullable=False, index=True)
    role = Column(String(50), nullable=False)
    role_label = Column(String(100), nullable=True)
    assignee_type = Column(SAEnum("internal","external", name="personnel_assignee_enum"), nullable=False)
    user_id = Column(Integer, ForeignKey("users.id", ondelete="SET NULL"), nullable=True)
    person_id = Column(Integer, ForeignKey("person_profiles.id", ondelete="SET NULL"), nullable=True)
    confirmed = Column(SAEnum("pending","confirmed","declined", name="personnel_confirm_enum"), default="pending")
    time_slot = Column(String(100), nullable=True)
    notes = Column(Text)
    order = Column(Integer, default=0)
    event = relationship("Event", back_populates="personnel")

class EventAttendee(Base):
    __tablename__ = "event_attendees"
    id = Column(Integer, primary_key=True)
    event_id = Column(Integer, ForeignKey("events.id", ondelete="CASCADE"), nullable=False, index=True)
    person_id = Column(Integer, ForeignKey("person_profiles.id", ondelete="CASCADE"), nullable=False, index=True)
    checked_in = Column(Boolean, default=False)
    role_at_event = Column(String(100), nullable=True)
    source = Column(SAEnum("manual","excel_import", name="attendee_source_enum"), default="manual")
    event = relationship("Event", back_populates="attendees")
    person = relationship("PersonProfile", back_populates="event_attendances")

class FeedbackItem(Base):
    __tablename__ = "feedback_items"
    id = Column(Integer, primary_key=True)
    event_id = Column(Integer, ForeignKey("events.id", ondelete="CASCADE"), nullable=False, index=True)
    content = Column(Text, nullable=False)
    category = Column(String(50), default="question")
    raised_by = Column(String(200), nullable=True)
    raised_by_person_id = Column(Integer, ForeignKey("person_profiles.id", ondelete="SET NULL"), nullable=True)
    status = Column(SAEnum("open","in_progress","closed", name="feedback_status_enum"), default="open")
    assignee_id = Column(Integer, ForeignKey("users.id", ondelete="SET NULL"), nullable=True)
    created_at = Column(DateTime, default=datetime.utcnow)
    event = relationship("Event", back_populates="feedback_items")
    issue_links = relationship("IssueLink", back_populates="feedback", cascade="all, delete-orphan")

class IssueLink(Base):
    __tablename__ = "issue_links"
    id = Column(Integer, primary_key=True)
    feedback_id = Column(Integer, ForeignKey("feedback_items.id", ondelete="CASCADE"), nullable=False, index=True)
    platform = Column(SAEnum("github","gitcode","gitee", name="issue_platform_enum"), nullable=False)
    repo = Column(String(200), nullable=False)
    issue_number = Column(Integer, nullable=False)
    issue_url = Column(String(500), nullable=False)
    issue_type = Column(SAEnum("issue","pr", name="issue_type_enum"), default="issue")
    issue_status = Column(SAEnum("open","closed", name="issue_status_enum"), default="open")
    linked_at = Column(DateTime, default=datetime.utcnow)
    linked_by_id = Column(Integer, ForeignKey("users.id", ondelete="SET NULL"), nullable=True)
    feedback = relationship("FeedbackItem", back_populates="issue_links")

class EventTask(Base):
    __tablename__ = "event_tasks"
    id = Column(Integer, primary_key=True)
    event_id = Column(Integer, ForeignKey("events.id", ondelete="CASCADE"), nullable=False, index=True)
    title = Column(String(300), nullable=False)
    task_type = Column(SAEnum("task","milestone", name="task_type_enum"), default="task")
    phase = Column(SAEnum("pre","during","post", name="task_phase_enum"), default="pre")
    start_date = Column(Date, nullable=True)
    end_date = Column(Date, nullable=True)
    progress = Column(Integer, default=0)
    status = Column(SAEnum("not_started","in_progress","completed","blocked", name="task_status_enum"), default="not_started")
    depends_on = Column(JSON, default=list)  # list[int]，JSON 存储
    parent_task_id = Column(Integer, ForeignKey("event_tasks.id", ondelete="SET NULL"), nullable=True)
    order = Column(Integer, default=0)
    event = relationship("Event", back_populates="tasks")
```

对应迁移 `005_add_event_module.py`（`down_revision = "004"`）— 按以上表结构创建，此处略去重复 DDL，实际用 `alembic revision --autogenerate` 自动生成后人工检查即可。

---

### 3.4 后端 API 实现

#### 新建 `api/people.py`（关键路由清单）

```
GET    /api/people                 → 人脉列表（分页 + 筛选）
POST   /api/people                 → 手动创建
GET    /api/people/{id}            → 详情（含计算字段）
PATCH  /api/people/{id}            → 更新
DELETE /api/people/{id}            → 删除
GET    /api/people/{id}/roles      → 社区身份历史
POST   /api/people/{id}/roles      → 添加社区身份
POST   /api/people/import          → Excel/CSV 批量导入（返回导入结果含疑似匹配列表）
POST   /api/people/confirm-merge   → 确认/拒绝疑似匹配
```

列表查询参数：`q`（姓名/邮箱模糊）、`tag`、`company`、`source`、`page`、`page_size`

#### 新建 `api/events.py`（关键路由清单）

```
GET    /api/events                          → 活动列表
POST   /api/events                          → 创建活动（可选 template_id）
GET    /api/events/{id}                     → 活动详情
PATCH  /api/events/{id}                     → 更新活动（含结果字段）
PATCH  /api/events/{id}/status              → 推进状态流转
GET    /api/events/{id}/checklist           → Checklist 列表
PATCH  /api/events/{id}/checklist/{item_id} → 更新检查项状态
GET    /api/events/{id}/personnel           → 人员安排列表
POST   /api/events/{id}/personnel           → 添加人员
PATCH  /api/events/{id}/personnel/{pid}/confirm → 更新确认状态
POST   /api/events/{id}/attendees/import    → 签到名单 Excel 导入
GET    /api/events/{id}/feedback            → 反馈问题列表
POST   /api/events/{id}/feedback            → 录入反馈问题
POST   /api/events/{id}/feedback/{fid}/links → 关联 Issue

GET    /api/event-templates                 → 模板列表
POST   /api/event-templates                 → 创建模板
GET    /api/event-templates/{id}            → 模板详情
PATCH  /api/event-templates/{id}            → 更新模板
```

#### 注册路由到 `main.py`

```python
from app.api import events, event_templates, people  # 新增

app.include_router(people.router, prefix="/api/people", tags=["people"])
app.include_router(events.router, prefix="/api/events", tags=["events"])
app.include_router(event_templates.router, prefix="/api/event-templates", tags=["event-templates"])
```

#### `models/__init__.py` 补充导入

```python
from app.models.people import PersonProfile, CommunityRole
from app.models.event import (
    Event, EventTemplate, ChecklistTemplateItem, ChecklistItem,
    EventPersonnel, EventAttendee, EventTask, FeedbackItem, IssueLink,
)
```

---

### 3.5 签到名单导入服务

新建 `backend/app/services/people_service.py`：

```python
from difflib import SequenceMatcher
from sqlalchemy.orm import Session
from app.models.people import PersonProfile
from app.models.event import EventAttendee

def find_or_suggest(db: Session, row: dict) -> dict:
    """
    对导入的单行记录执行去重匹配。
    返回: {"status": "matched"|"suggest"|"new", "person_id": int|None, "candidates": list}
    """
    github = row.get("github_handle", "").strip().lower()
    email = row.get("email", "").strip().lower()
    name = row.get("display_name", "").strip()
    company = row.get("company", "").strip()

    # 1. github_handle 精确匹配
    if github:
        p = db.query(PersonProfile).filter(PersonProfile.github_handle == github).first()
        if p:
            return {"status": "matched", "person_id": p.id, "candidates": []}

    # 2. email 精确匹配 → 疑似
    if email:
        p = db.query(PersonProfile).filter(PersonProfile.email == email).first()
        if p:
            return {"status": "suggest", "person_id": None,
                    "candidates": [{"id": p.id, "display_name": p.display_name, "reason": "email"}]}

    # 3. 姓名+公司模糊匹配
    if name:
        candidates = []
        for p in db.query(PersonProfile).filter(PersonProfile.display_name.ilike(f"%{name[:4]}%")).limit(50):
            ratio = SequenceMatcher(None, f"{name}|{company}", f"{p.display_name}|{p.company or ''}").ratio()
            if ratio > 0.70:
                candidates.append({"id": p.id, "display_name": p.display_name,
                                   "company": p.company, "ratio": round(ratio, 2), "reason": "name+company"})
        if candidates:
            return {"status": "suggest", "person_id": None,
                    "candidates": sorted(candidates, key=lambda x: -x["ratio"])}

    return {"status": "new", "person_id": None, "candidates": []}


def create_person_from_row(db: Session, row: dict, source: str, created_by_id: int | None) -> PersonProfile:
    p = PersonProfile(
        display_name=row.get("display_name", ""),
        email=row.get("email") or None,
        github_handle=row.get("github_handle") or None,
        company=row.get("company") or None,
        source=source,
        created_by_id=created_by_id,
    )
    db.add(p)
    db.flush()  # 获取 id
    return p
```

导入端点核心逻辑（在 `api/events.py` 中）：

```python
@router.post("/{event_id}/attendees/import")
async def import_attendees(event_id: int, file: UploadFile, db=Depends(get_db), user=Depends(get_current_user)):
    import openpyxl, io
    wb = openpyxl.load_workbook(io.BytesIO(await file.read()))
    ws = wb.active
    headers = [str(c.value).strip().lower() for c in ws[1]]

    results = {"matched": [], "pending_confirm": [], "created": []}
    for row in ws.iter_rows(min_row=2, values_only=True):
        data = dict(zip(headers, row))
        match = find_or_suggest(db, data)
        if match["status"] == "matched":
            # 直接关联
            db.add(EventAttendee(event_id=event_id, person_id=match["person_id"], source="excel_import"))
            results["matched"].append(match["person_id"])
        elif match["status"] == "suggest":
            results["pending_confirm"].append({"row": data, "candidates": match["candidates"]})
        else:
            person = create_person_from_row(db, data, "event_import", user.id)
            db.add(EventAttendee(event_id=event_id, person_id=person.id, source="excel_import"))
            results["created"].append(person.id)
    db.commit()
    return results  # 前端展示 pending_confirm 供人工确认
```

---

### 3.6 前端页面

Phase 4a 需新增的前端文件（均放 `frontend/src/views/`）：

| 文件 | 说明 |
|------|------|
| `PeopleList.vue` | 人脉列表 + 标签/公司筛选 |
| `PeopleDetail.vue` | 档案详情（社区身份时间线 + 活动记录）|
| `PeopleImport.vue` | Excel 导入 + 疑似匹配确认对话框 |
| `EventList.vue` | 活动列表 + 状态筛选 |
| `EventDetail.vue` | 活动详情（Tab：基本信息 / Checklist / 人员安排 / 结果）|
| `EventTemplateList.vue` | SOP 模板管理 |

前端 API 模块新增（`frontend/src/api/`）：

```typescript
// people.ts
export const getPeople = (params) => request.get('/api/people', { params })
export const createPerson = (data) => request.post('/api/people', data)
export const importPeople = (eventId, file) => {
  const form = new FormData()
  form.append('file', file)
  return request.post(`/api/events/${eventId}/attendees/import`, form)
}

// events.ts
export const getEvents = (params) => request.get('/api/events', { params })
export const createEvent = (data) => request.post('/api/events', data)
export const updateChecklistItem = (eventId, itemId, data) =>
  request.patch(`/api/events/${eventId}/checklist/${itemId}`, data)
```

**`MyWork.vue` 扩展**：在现有"分配给我的内容"卡片之后追加：

```html
<!-- 活动检查项 -->
<el-card v-for="group in myChecklistGroups" :key="group.eventId">
  <template #header>{{ group.eventTitle }}</template>
  <el-checkbox v-for="item in group.items" :key="item.id"
    :model-value="item.status === 'done'"
    @change="toggleChecklist(item.id, $event)">
    {{ item.title }}
  </el-checkbox>
</el-card>
```

对应后端端点（追加到 `api/dashboard.py`）：

```python
@router.get("/my-checklist")
def my_checklist(db=Depends(get_db), user=Depends(get_current_user)):
    items = (db.query(ChecklistItem)
             .filter(ChecklistItem.assignee_id == user.id,
                     ChecklistItem.status == "pending")
             .order_by(ChecklistItem.due_date.nullslast(asc))
             .all())
    # 按 event 分组返回
    ...
```

---

## 4. Phase 4b — 甘特图 + 反馈 Issue 关联

### 4.1 甘特图后端

`EventTask` 模型已在 Phase 4a 的 `models/event.py` 中定义，本阶段补充 API：

```
GET    /api/events/{id}/tasks         → 任务列表（含子任务树形结构）
POST   /api/events/{id}/tasks         → 创建任务
PATCH  /api/events/{id}/tasks/{tid}   → 更新（进度 / 日期 / 状态）
DELETE /api/events/{id}/tasks/{tid}   → 删除
PATCH  /api/events/{id}/tasks/reorder → 批量重排序
```

任务列表返回树形结构时，后端统一展平后由前端重组（`parent_task_id` 字段即树路径）：

```python
def build_task_tree(tasks: list) -> list:
    """将平铺任务列表转为树形结构"""
    task_map = {t.id: {**t.__dict__, "children": []} for t in tasks}
    roots = []
    for t in tasks:
        if t.parent_task_id and t.parent_task_id in task_map:
            task_map[t.parent_task_id]["children"].append(task_map[t.id])
        else:
            roots.append(task_map[t.id])
    return roots
```

### 4.2 甘特图前端集成

安装依赖：

```bash
cd frontend && npm install frappe-gantt
```

在 `EventDetail.vue` 的甘特图 Tab 中：

```vue
<script setup lang="ts">
import Gantt from 'frappe-gantt'
import { onMounted, ref } from 'vue'

const ganttEl = ref<HTMLElement>()
let gantt: Gantt

onMounted(() => {
  const tasks = props.tasks.map(t => ({
    id: String(t.id),
    name: t.title,
    start: t.start_date,
    end: t.end_date,
    progress: t.progress,
    dependencies: t.depends_on?.join(',') ?? '',
  }))
  gantt = new Gantt(ganttEl.value!, tasks, {
    on_date_change: (task, start, end) => updateTask(+task.id, { start_date: start, end_date: end }),
    on_progress_change: (task, progress) => updateTask(+task.id, { progress }),
  })
})
</script>
<template>
  <div ref="ganttEl" class="gantt-container" />
</template>
```

> **Vue 3 兼容性**：`frappe-gantt` v0.6+ 是纯 DOM 操作库，无框架依赖，直接挂载到 `ref` 元素上即可。Phase 4b 启动前先做 10 分钟 POC 验证能正常渲染。

### 4.3 反馈 Issue 关联

`FeedbackItem` 和 `IssueLink` 模型已在 Phase 4a 定义。本阶段补充：

1. **Issue 状态定时同步**（新建 `services/issue_sync.py`）：

```python
import httpx
from sqlalchemy.orm import Session
from app.models.event import IssueLink

async def sync_issue_status(db: Session, token: str | None = None):
    headers = {"Authorization": f"token {token}"} if token else {}
    links = db.query(IssueLink).filter(IssueLink.platform == "github").all()
    async with httpx.AsyncClient() as client:
        for link in links:
            url = f"https://api.github.com/repos/{link.repo}/issues/{link.issue_number}"
            resp = await client.get(url, headers=headers)
            if resp.status_code == 200:
                link.issue_status = resp.json().get("state", "open")
    db.commit()
```

2. **在 `main.py` lifespan 中注册 APScheduler**（每日 02:00 执行）：

```python
from apscheduler.schedulers.asyncio import AsyncIOScheduler
scheduler = AsyncIOScheduler()

@asynccontextmanager
async def lifespan(app: FastAPI):
    init_db()
    scheduler.add_job(sync_issue_status_job, "cron", hour=2)
    scheduler.start()
    yield
    scheduler.shutdown()
```

---

## 5. Phase 4c — Campaign

### 5.1 数据模型

新建 `backend/app/models/campaign.py`：

```python
from datetime import datetime
from sqlalchemy import Column, Date, DateTime, ForeignKey, Integer, String, Text
from sqlalchemy import Enum as SAEnum
from sqlalchemy.orm import relationship
from app.database import Base

class Campaign(Base):
    __tablename__ = "campaigns"
    id = Column(Integer, primary_key=True)
    community_id = Column(Integer, ForeignKey("communities.id", ondelete="CASCADE"), nullable=False, index=True)
    name = Column(String(300), nullable=False)
    description = Column(Text)
    type = Column(SAEnum("promotion","care","invitation","survey", name="campaign_type_enum"), nullable=False)
    status = Column(SAEnum("draft","active","completed","archived", name="campaign_status_enum"), default="draft")
    target_count = Column(Integer, nullable=True)
    owner_id = Column(Integer, ForeignKey("users.id", ondelete="SET NULL"), nullable=True)
    start_date = Column(Date, nullable=True)
    end_date = Column(Date, nullable=True)
    created_at = Column(DateTime, default=datetime.utcnow)

    contacts = relationship("CampaignContact", back_populates="campaign", cascade="all, delete-orphan")
    activities = relationship("CampaignActivity", back_populates="campaign", cascade="all, delete-orphan")

class CampaignContact(Base):
    __tablename__ = "campaign_contacts"
    id = Column(Integer, primary_key=True)
    campaign_id = Column(Integer, ForeignKey("campaigns.id", ondelete="CASCADE"), nullable=False, index=True)
    person_id = Column(Integer, ForeignKey("person_profiles.id", ondelete="CASCADE"), nullable=False, index=True)
    status = Column(
        SAEnum("pending","contacted","responded","converted","declined", name="contact_status_enum"),
        default="pending",
    )
    channel = Column(SAEnum("email","wechat","phone","in_person","other", name="contact_channel_enum"), nullable=True)
    added_by = Column(SAEnum("manual","event_import","ecosystem_import","csv_import", name="contact_source_enum"), default="manual")
    last_contacted_at = Column(DateTime, nullable=True)
    notes = Column(Text)
    assigned_to_id = Column(Integer, ForeignKey("users.id", ondelete="SET NULL"), nullable=True)
    campaign = relationship("Campaign", back_populates="contacts")
    person = relationship("PersonProfile")

class CampaignActivity(Base):
    __tablename__ = "campaign_activities"
    id = Column(Integer, primary_key=True)
    campaign_id = Column(Integer, ForeignKey("campaigns.id", ondelete="CASCADE"), nullable=False, index=True)
    person_id = Column(Integer, ForeignKey("person_profiles.id", ondelete="CASCADE"), nullable=False, index=True)
    action = Column(SAEnum("sent_email","made_call","sent_wechat","in_person_meeting","got_reply","note",
                           name="campaign_action_enum"), nullable=False)
    content = Column(Text)
    outcome = Column(String(300))
    operator_id = Column(Integer, ForeignKey("users.id", ondelete="SET NULL"), nullable=True)
    created_at = Column(DateTime, default=datetime.utcnow)
    campaign = relationship("Campaign", back_populates="activities")
```

迁移 `006_add_campaign_module.py`（`down_revision = "005"`）：用 `--autogenerate` 生成后审查。

### 5.2 Campaign API 路由

新建 `api/campaigns.py`：

```
GET    /api/campaigns               → 列表（按类型/状态过滤）
POST   /api/campaigns               → 创建
GET    /api/campaigns/{id}          → 详情（含各状态联系人统计）
PATCH  /api/campaigns/{id}          → 更新
POST   /api/campaigns/{id}/contacts/import-event   → 从活动签到导入
POST   /api/campaigns/{id}/contacts/import-people  → 从人脉库筛选导入
POST   /api/campaigns/{id}/contacts/import-csv     → CSV 批量导入
POST   /api/campaigns/{id}/contacts/{cid}/activities → 记录跟进动作
PATCH  /api/campaigns/{id}/contacts/{cid}/status    → 更新联系人状态
```

概览端点需要返回漏斗数据（与前端 ECharts 对接）：

```python
@router.get("/{campaign_id}/funnel")
def campaign_funnel(campaign_id: int, db=Depends(get_db), ...):
    from sqlalchemy import func
    rows = (db.query(CampaignContact.status, func.count())
            .filter(CampaignContact.campaign_id == campaign_id)
            .group_by(CampaignContact.status).all())
    return {status: count for status, count in rows}
```

### 5.3 `MyWork.vue` Campaign 扩展

后端追加端点 `GET /api/users/me/dashboard/my-campaigns`：

```python
pending = (db.query(CampaignContact)
           .filter(CampaignContact.assigned_to_id == user.id,
                   CampaignContact.status == "pending")
           .all())
# 按 campaign_id 分组返回
```

---

## 6. Phase 4d — 生态洞察

### 6.1 数据模型

新建 `backend/app/models/ecosystem.py`：

```python
from datetime import datetime
from sqlalchemy import Boolean, Column, DateTime, ForeignKey, Integer, JSON, String, Text
from sqlalchemy import Enum as SAEnum
from sqlalchemy.orm import relationship
from app.database import Base

class EcosystemProject(Base):
    __tablename__ = "ecosystem_projects"
    id = Column(Integer, primary_key=True)
    name = Column(String(200), nullable=False)
    platform = Column(SAEnum("github","gitee","gitcode", name="eco_platform_enum"), nullable=False)
    org_name = Column(String(200), nullable=False)
    repo_name = Column(String(200), nullable=True)
    description = Column(Text)
    tags = Column(JSON, default=list)
    is_active = Column(Boolean, default=True)
    last_synced_at = Column(DateTime, nullable=True)
    added_by_id = Column(Integer, ForeignKey("users.id", ondelete="SET NULL"), nullable=True)

    contributors = relationship("EcosystemContributor", back_populates="project", cascade="all, delete-orphan")

class EcosystemContributor(Base):
    __tablename__ = "ecosystem_contributors"
    id = Column(Integer, primary_key=True)
    project_id = Column(Integer, ForeignKey("ecosystem_projects.id", ondelete="CASCADE"), nullable=False, index=True)
    github_handle = Column(String(100), nullable=False, index=True)
    display_name = Column(String(200))
    avatar_url = Column(String(500))
    role = Column(String(50))
    commit_count_90d = Column(Integer)
    pr_count_90d = Column(Integer)
    star_count = Column(Integer)
    followers = Column(Integer)
    person_id = Column(Integer, ForeignKey("person_profiles.id", ondelete="SET NULL"), nullable=True, index=True)
    last_synced_at = Column(DateTime, default=datetime.utcnow)

    project = relationship("EcosystemProject", back_populates="contributors")
    person = relationship("PersonProfile")
```

迁移 `007_add_ecosystem_module.py`（`down_revision = "006"`）：`--autogenerate` 后审查。

### 6.2 GitHub 采集服务

新建 `backend/app/services/ecosystem/github_crawler.py`：

```python
import httpx
from sqlalchemy.orm import Session
from app.models.ecosystem import EcosystemProject, EcosystemContributor
from app.config import settings

async def sync_project(db: Session, project: EcosystemProject) -> None:
    token = settings.GITHUB_PAT  # 从 .env 读取，未配置则跳过
    headers = {"Authorization": f"token {token}"} if token else {}
    base = "https://api.github.com"

    async with httpx.AsyncClient(timeout=30) as client:
        # 获取贡献者列表
        url = f"{base}/repos/{project.org_name}/{project.repo_name}/contributors"
        resp = await client.get(url, headers=headers, params={"per_page": 100})
        if resp.status_code != 200:
            return

        existing = {c.github_handle: c for c in project.contributors}
        for item in resp.json():
            handle = item["login"]
            if handle in existing:
                existing[handle].commit_count_90d = item.get("contributions")
            else:
                db.add(EcosystemContributor(
                    project_id=project.id,
                    github_handle=handle,
                    display_name=item.get("login"),
                    avatar_url=item.get("avatar_url"),
                    commit_count_90d=item.get("contributions"),
                ))
    from datetime import datetime
    project.last_synced_at = datetime.utcnow()
    db.commit()
```

`config.py` 中追加：

```python
GITHUB_PAT: str | None = None   # 可选，配置后启用自动同步
```

### 6.3 API 路由

新建 `api/ecosystem.py`：

```
GET    /api/ecosystem                     → 监控项目列表（仅 admin+）
POST   /api/ecosystem                     → 添加监控项目
PATCH  /api/ecosystem/{id}                → 编辑
POST   /api/ecosystem/{id}/sync           → 手动触发同步
GET    /api/ecosystem/{id}/contributors   → 贡献者列表
POST   /api/ecosystem/{id}/contributors/{handle}/import-person → 导入人脉库
```

权限控制：所有端点使用 `get_current_admin_or_superuser` 依赖。

### 6.4 前端

新增视图：

| 文件 | 说明 |
|------|------|
| `EcosystemList.vue` | 监控项目卡片列表 |
| `EcosystemDetail.vue` | 指标趋势图 + 贡献者排行 + 一键导入人脉按钮 |

趋势图使用 ECharts（已有依赖），折线图展示 30/60/90 天 Star/Fork 趋势。

---

## 7. 测试策略

### 7.1 每个阶段的最低测试要求

| Phase | 测试文件 | 覆盖重点 |
|-------|---------|---------|
| 前置重构 | `tests/test_contents_api.py`（更新） | 多社区关联创建/查询；`community_admin` 迁移后权限验证 |
| Phase 4a | `tests/test_people_api.py` | PersonProfile CRUD；去重匹配（`find_or_suggest`）；Excel 导入返回 pending_confirm |
| Phase 4a | `tests/test_events_api.py` | Event 创建/状态流转；Checklist 实例化；人员安排 |
| Phase 4b | `tests/test_events_api.py`（扩展）| EventTask CRUD；IssueLink 关联；Issue 状态同步 mock |
| Phase 4c | `tests/test_campaigns_api.py` | Campaign CRUD；多维度联系人导入；漏斗统计 |
| Phase 4d | `tests/test_ecosystem_api.py` | EcosystemProject CRUD（admin 鉴权）；sync 端点（mock GitHub API）|

### 7.2 `people_service` 单元测试（无 HTTP client）

```python
# tests/test_people_service.py
from unittest.mock import MagicMock
from app.services.people_service import find_or_suggest

def test_github_exact_match():
    db = MagicMock()
    mock_person = MagicMock(id=1)
    db.query().filter().first.return_value = mock_person
    result = find_or_suggest(db, {"github_handle": "torvalds"})
    assert result["status"] == "matched"
    assert result["person_id"] == 1

def test_no_match_creates_new():
    db = MagicMock()
    db.query().filter().first.return_value = None
    db.query().filter().limit().return_value = []
    result = find_or_suggest(db, {"display_name": "张三"})
    assert result["status"] == "new"
```

### 7.3 关键陷阱提示

| 问题 | 说明 |
|------|------|
| SQLite Enum 冲突 | 同一 Python 进程中多个同名 Enum（如 `event_type_enum` 在 `EventTemplate` 和 `Event` 中）会引发 SQLAlchemy 报错。解决：每个表定义唯一的 `name` 参数，或统一在文件顶部 `event_type = SAEnum("online","offline","hybrid", name="event_type_enum", create_constraint=True)` 然后复用该变量。 |
| `alembic --autogenerate` JSON 字段 | SQLite 不原生支持 JSON 类型，Alembic 自动生成可能写 `String`。手动检查并改为 `sa.JSON`。 |
| `community_id` 过渡期 | 内容迁移两步之间，`contents.community_id` 仍存在。`api/contents.py` 中需同时写入旧字段（兼容）直至执行 `009_remove_content_community_id.py`。 |
| `get_community_admin` 引用 | 用 `grep -r "get_community_admin" backend/app/api/` 找到所有引用，统一替换为 `get_current_admin_or_superuser`，否则权限模型简化后老接口无法调用。 |

---

**文档版本**: v1.0 — 初版实施方案
**配套文档**: [02-新模块需求分析.md](../requirements/02-新模块需求分析.md)



