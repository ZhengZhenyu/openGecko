# openGecko - 产品需求分析文档（PRD）

**产品名称**: openGecko — 多社区运营管理平台
**文档版本**: v3.0
**更新日期**: 2026-02-21
**文档状态**: 与当前代码实现同步（已交付功能的完整记录）

---

## 目录

1. [执行摘要](#1-执行摘要)
2. [业务背景与问题陈述](#2-业务背景与问题陈述)
3. [用户角色与画像](#3-用户角色与画像)
4. [已实现功能模块详述](#4-已实现功能模块详述)
5. [非功能需求](#5-非功能需求)
6. [数据需求](#6-数据需求)
7. [技术约束](#7-技术约束)
8. [验收标准](#8-验收标准)
9. [术语表](#9-术语表)
10. [变更记录](#10-变更记录)

---

## 1. 执行摘要

openGecko 是面向**开源社区运营团队**的企业级多租户内容管理与运营平台。系统以"社区"为第一公民，让社区项目经理（PM）进入系统后即可感知当前社区的整体运营状态，并从同一工作台完成内容创作、多渠道发布、委员会治理、会议管理等日常工作。

**核心价值主张**：Manage All, Publish Everywhere。

**当前已交付能力**：
- **多租户架构**：共享数据库 + community_id 行级隔离，三级 RBAC（superuser / admin / user）
- **内容全生命周期管理**：上传 / 编辑 / 审核工作流 / 排期日历 / 多人协作
- **四渠道发布**：微信公众号（API 自动）、Hugo（文件生成）、CSDN / 知乎（格式复制）
- **社区治理**：委员会管理、会议管理（ICS 导出）、个人工作台
- **数据与安全**：发布记录追踪、审计日志、渠道凭证 Fernet 加密、SMTP 密码重置

---

## 2. 业务背景与问题陈述

### 2.1 业务背景

开源基金会通常同时运营多个开源社区（如 openEuler、openGauss、MindSpore 等），每个社区都有独立的内容产出需求、发布渠道账号和治理结构。现有运营痛点包括：

| 痛点 | 具体表现 |
|------|---------|
| 多渠道发布效率低 | 同一篇文章需手动复制粘贴到微信、CSDN、知乎，格式调整耗时 |
| 内容状态不可见 | 多人协作时无法统一追踪哪些内容在审核、哪些已排期 |
| 社区数据分散 | 跨社区的内容产出、发布效果数据无法统一分析 |
| 治理协作低效 | 委员会成员信息和会议安排散落在各处文档和电子表格 |
| 权限边界不清 | 不同社区管理员不应互相看到对方数据，但缺少系统级隔离 |

### 2.2 解决方案定位

openGecko 以"社区"为核心组织单元，提供：
1. **统一登录入口**：所有社区数据在同一平台管理，切换社区自动切换数据视角
2. **以 PM 工作流为中心的设计**：内容策划 → 协作编辑 → 审核发布 → 治理管理，全流程贯通
3. **数据安全隔离**：`community_id` 强过滤，普通用户绝不可见其他社区数据

---

## 3. 用户角色与画像

### 3.1 角色定义

系统实现三级权限体系：

| 角色 | 标识 | 数量估计 | 数据范围 |
|------|------|---------|---------|
| **平台超级管理员** | `is_superuser=True` | 1-2 人 | 全平台所有社区 |
| **社区管理员** | `community_users.role='admin'` | 每社区 1-3 人 | 所属社区 |
| **社区普通用户** | `community_users.role='user'` | 每社区 3-10 人 | 所属社区内自己负责的内容 |

### 3.2 用户画像

#### 平台超级管理员（Superuser）

- **场景**：开源基金会运营总监，负责创建和维护多个社区，分配成员，监控整体数据
- **核心需求**：
  - 创建/删除社区，全局用户管理
  - 跨社区工作量总览（`/workload-overview`）
  - 配置 SMTP 邮件、渠道凭证等平台级设置
- **使用频率**：低频（以配置和监控为主）

#### 社区管理员（Admin）

- **场景**：社区 PM，负责本社区全部日常运营
- **核心需求**：
  - 早上登录即看到社区全貌（社区总览 / Community Overview）
  - 管理内容：创建、分配责任人、推进审核流程、排期发布
  - 管理成员：添加/移除成员、调整角色
  - 配置渠道凭证（微信 AppID 等）
  - 管理委员会和会议
- **使用频率**：高频（每日使用）

#### 社区普通用户（User）

- **场景**：内容创作者 / 技术专家
- **核心需求**：
  - 编写和上传自己负责的内容（DOCX / Markdown）
  - 查看个人工作台（`/my-work`）了解分配给自己的任务
  - 参与内容协作编辑
- **使用频率**：中频（按任务驱动）

---

## 4. 已实现功能模块详述

### 4.1 认证与账号安全

#### 4.1.1 用户登录

- 用户名 + 密码登录，返回 JWT Token（有效期 7 天）
- Token 存储于 localStorage，API 请求自动附加 `Authorization: Bearer {token}`
- 响应 401 时自动清空状态并跳转登录页

#### 4.1.2 首次启动初始化流程

- 系统首次启动时创建默认临时管理员账号（`admin` / `admin123`，`is_default_admin=True`）
- 引导管理员在 `/initial-setup` 页面创建正式账号（用户名、密码、邮箱）
- 正式账号创建后，默认临时账号**自动删除**（不可跳过的安全机制）

#### 4.1.3 密码重置

- 用户点击「忘记密码」→ 输入邮箱 → 收到含一次性 Token 的重置链接（有效期 1 小时）
- Token 写入 `password_reset_tokens` 表，使用后标记 `used=True` 不可复用
- 需要 SMTP 邮件服务器配置（`SMTP_HOST`、`SMTP_PORT`、`SMTP_USER` 等环境变量）

**用户故事**：
```
作为忘记密码的用户，
我想通过邮件找回账号，
以便无需联系管理员即可自助重置密码。

验收标准：
- 邮件在 60 秒内到达
- 链接有效期 1 小时，过期返回明确错误提示
- 同一链接只能使用一次
- 重置成功后旧密码立即失效
```

---

### 4.2 社区管理

#### 4.2.1 社区 CRUD

| 操作 | 权限 | 说明 |
|------|------|------|
| 创建社区 | Superuser | 必填：名称、slug（全局唯一）|
| 编辑社区 | Superuser / Admin | 可改：名称、描述、官网 URL、Logo |
| 删除社区 | Superuser | 级联删除全部内容、配置、日志 |
| 查看社区列表 | 已登录用户 | 仅展示当前用户所属的社区 |

#### 4.2.2 社区切换器

- 导航栏顶部展示当前社区，点击可切换
- 切换后所有数据自动过滤到新社区
- 当前社区 ID 持久化到 localStorage

#### 4.2.3 成员管理

- Admin / Superuser 可添加已注册用户为社区成员，指定角色（admin / user）
- 支持角色变更、成员移除
- 成员列表展示用户名、邮箱、角色、加入时间

---

### 4.3 内容管理

#### 4.3.1 内容创建方式

| 方式 | 说明 |
|------|------|
| 在线创建 | 填写标题 + Markdown 编辑器（md-editor-v3），实时预览 |
| DOCX 上传 | 自动提取图片到 `/uploads/images/`，转换为 Markdown |
| MD 文件上传 | 直接解析 Markdown 内容 |

**源文件类型**（`source_type`）：`contribution`（社区投稿）/ `release_note`（发版说明）/ `event_summary`（活动总结）

#### 4.3.2 内容工作流状态

```
draft（草稿）→ reviewing（审核中）→ approved（已通过）→ published（已发布）
```

| 状态 | 颜色语义 | 可流转到 |
|------|---------|---------|
| draft | 灰色 | reviewing、published |
| reviewing | 橙色 | approved、draft |
| approved | 蓝色 | published、draft |
| published | 绿色 | — |

**工作状态**（独立字段 `work_status`）：`planning` / `in_progress` / `completed`

#### 4.3.3 内容所有权与协作模型

| 字段/关系 | 说明 | 可变 |
|---------|------|------|
| `created_by_user_id` | 原始创建者 | 不可变 |
| `owner_id` | 当前内容所有者 | 可转让 |
| `content_collaborators` | 协作编辑者（多对多）| 可增删 |
| `content_assignees` | 责任人（多对多，出现在工作台）| 可增删 |

**编辑权限**：owner、collaborators、社区 admin、superuser 均可编辑内容。

#### 4.3.4 内容排期（日历功能）

- `scheduled_publish_at` 字段记录计划发布时间
- `/content-calendar` 使用 FullCalendar 月视图展示排期
- 支持拖拽内容到指定日期自动更新排期

#### 4.3.5 封面图管理

- 独立上传接口：`POST /api/contents/{id}/cover`
- 存储路径：`/uploads/covers/`
- 微信发布必须先上传封面图（用于素材库）

---

### 4.4 多渠道发布

#### 4.4.1 微信公众号（自动发布）

**前置条件**：社区已配置有效的 AppID + AppSecret

**发布流程**：
1. 自动上传封面图到微信素材库（永久素材）
2. 转换 Markdown 为微信兼容 HTML（内联样式）
3. 调用 API 创建草稿，返回草稿 ID
4. 发布记录状态设为 `draft`（等待人工在微信后台发布）

**错误处理**：
- 未配置 AppID/Secret → 提示"请先配置微信渠道"
- 缺少封面图 → 提示"请先上传封面图"
- 微信 API 调用失败 → 记录 `error_message` 到发布记录

#### 4.4.2 Hugo 博客（文件生成）

- 生成带 front matter 的 `.md` 文件
- 写入配置的本地仓库路径（`{repo_path}/content/posts/`）
- front matter 包含：title、date、author、tags、categories

#### 4.4.3 CSDN / 知乎（格式复制）

- 生成适配各平台格式的内容
- 提供「一键复制」按钮，用户手动粘贴到平台发布

#### 4.4.4 发布记录

所有发布操作均写入 `publish_records` 表：

| 字段 | 说明 |
|------|------|
| channel | 渠道（wechat / hugo / csdn / zhihu）|
| status | pending / draft / published / failed |
| platform_article_id | 平台返回的文章 ID（微信草稿 ID）|
| platform_url | 平台文章 URL |
| error_message | 失败原因 |

---

### 4.5 渠道配置管理

- 每个社区可独立配置 4 个渠道（每社区每渠道一条记录）
- 敏感字段（AppSecret、Cookie）使用 **Fernet 加密**存储，API 返回时脱敏（仅显示末 4 位）
- 支持启用 / 禁用开关

| 渠道 | 配置项 |
|------|------|
| 微信公众号 | AppID、AppSecret |
| Hugo 博客 | 本地仓库路径、content 目录 |
| CSDN | Cookie |
| 知乎 | Cookie |

---

### 4.6 社区治理

#### 4.6.1 委员会管理

委员会（Committee）是社区治理结构的基本单元：

| 字段 | 说明 |
|------|------|
| name / slug | 委员会名称和 URL 标识（社区内唯一）|
| meeting_frequency | 会议频率：monthly / quarterly / yearly |
| notification_email | 通知邮件 |
| established_at | 成立时间 |

委员会成员（CommitteeMember）为**外部人员**（非系统账号），记录：

| 字段 | 说明 |
|------|------|
| name / email / phone / wechat | 联系信息 |
| organization | 所在机构 |
| github_id / gitcode_id | 开源平台账号 |
| roles | 角色标签（JSON 数组）：主席 / 副主席 / 委员 / 常务委员 |
| term_start / term_end | 任期 |
| is_active | 是否在任 |

#### 4.6.2 会议管理

| 字段 | 说明 |
|------|------|
| committee_id | 所属委员会（必须先创建委员会）|
| scheduled_at | 计划时间 |
| duration | 持续时长（分钟，默认 120）|
| location_type | online / offline / hybrid |
| status | scheduled / in_progress / completed / cancelled |
| work_status | planning / in_progress / completed |
| agenda | 会议议程（Markdown）|
| minutes | 会议纪要（Markdown）|
| attachments | 附件列表（JSON）|

**会议责任人**（`meeting_assignees`）：绑定系统用户账号，出现在个人工作台。

**会议与会人**（`meeting_participants`）：记录参会人员姓名和邮箱，支持从委员会成员一键导入。

#### 4.6.3 ICS 日历导出

- `GET /api/meetings/{id}/ics` 下载 `.ics` 格式日历文件
- 可导入 Google Calendar、Apple Calendar、Outlook 等客户端

#### 4.6.4 会议日历视图

`/meeting-calendar` 使用 FullCalendar 展示本社区所有会议，支持按委员会、状态过滤。

**用户故事**：
```
作为社区管理员，
我想在会议日历中看到本社区所有委员会的会议安排，
以便合理安排时间并避免冲突。

验收标准：
- 日历展示当月及前后各一个月的会议
- 点击会议可查看详情并导出 ICS
- 支持按委员会/状态过滤
```

---

### 4.7 个人工作台

`/my-work` 页面聚合**跨社区**所有分配给当前用户的任务：

| 区域 | 内容 |
|------|------|
| 我负责的内容 | 被指定为 assignee 的内容，展示标题、状态、所属社区、排期 |
| 我负责的会议 | 被指定为 assignee 的会议，展示标题、时间、委员会 |
| 统计概览 | 各状态任务数量汇总 |

**用户故事**：
```
作为社区成员，
我想在个人工作台看到所有分配给我的内容和会议（跨社区），
以便我不遗漏任何任务。

验收标准：
- 聚合所有社区中 assignee=当前用户 的记录
- 按截止时间/排期升序排列
- 点击可直接跳转到对应内容/会议详情
- 显示所属社区标签（支持同时在多个社区的用户）
```

---

### 4.8 社区总览仪表板

`/community-overview` 为社区管理员提供"一进系统即掌握社区状态"的工作台，展示：

| 数据 | 说明 |
|------|------|
| 内容统计 | 各工作流状态内容数量（reviewing_contents 等）|
| 成员统计 | total_members |
| 委员会统计 | total_committees |
| 即将召开的会议 | upcoming_meetings |
| 活跃渠道数 | active_channels |
| 发布趋势 | monthly_trend（近 12 个月月度发布量）|

社区日历组件（内容排期 + 近期会议）置于页面顶部，以时间线为主轴呈现社区近况。

---

### 4.9 工作量总览（Superuser 专属）

`/workload-overview` 仅 superuser 可访问，展示跨社区的内容产出和发布情况对比，用于全局数据分析和绩效追踪。

---

### 4.10 数据分析

`/analytics` 提供多维度统计图表：

| 图表 | 接口 | 说明 |
|------|------|------|
| 概览统计 | `/api/analytics/overview` | 总内容数、总发布数、发布成功率等 |
| 按渠道统计 | `/api/analytics/by-channel` | 各渠道发布量对比 |
| 按作者统计 | `/api/analytics/by-author` | TOP 作者贡献排名 |
| 发布趋势 | `/api/analytics/trend` | 近 N 天/月发布量折线图 |
| 分类分布 | `/api/analytics/category-distribution` | 各内容分类占比 |

---

### 4.11 审计日志

所有关键操作自动写入 `audit_logs` 表，内容包括：操作用户、所属社区、操作类型、资源 ID、详细信息（JSON）、客户端 IP、时间戳。管理员可按用户、时间范围、操作类型筛选查看。

---

## 5. 非功能需求

### 5.1 性能

| 指标 | 要求 |
|------|------|
| API 响应时间 | 95% 请求 < 500ms |
| 页面首屏加载 | < 2s（Vite 代码分割 + 路由懒加载）|
| 日历渲染 | 100 个事件 < 1s |
| 并发用户 | 支持 50 用户同时在线 |

### 5.2 安全

| 类别 | 实现方案 |
|------|---------|
| 身份认证 | JWT，HTTPS 传输，7 天有效期 |
| 密码存储 | bcrypt（成本因子 12），不可逆 |
| 渠道凭证 | Fernet 对称加密（密钥派生自 JWT_SECRET_KEY）|
| SQL 注入 | SQLAlchemy ORM 参数化查询，禁止裸 SQL |
| XSS | Vue 3 模板自动转义，限制 v-html |
| CSRF | JWT 在 Header 传递，天然免疫 |
| 文件上传 | 白名单扩展名 + MIME 类型验证，随机文件名，限 10MB |
| 跨租户隔离 | get_current_community 依赖注入，API 层强制 community_id 过滤 |
| 操作审计 | 关键操作写入 audit_logs，永久保留 |

### 5.3 可用性

- 系统可用性目标：99.5%（月停机时间 < 3.6 小时）
- 数据备份：每日自动备份（生产环境建议 pg_dump + 异地存储）

### 5.4 兼容性

| 类别 | 支持范围 |
|------|---------|
| 浏览器 | Chrome 90+、Firefox 88+、Safari 14+、Edge 90+ |
| 屏幕分辨率 | 最小 1366×768 |
| 移动端 | 暂不支持（桌面端优先）|

### 5.5 测试覆盖率

- 后端单元测试覆盖率 ≥ 80%（CI 强制检查，低于则 Pipeline 失败）
- 测试使用 pytest，mock 所有外部服务（SMTP、微信 API）

---

## 6. 数据需求

### 6.1 数据量估算（5 年，10 社区）

| 数据类型 | 估算量 |
|---------|-------|
| 内容 | 12,000 条 |
| 发布记录 | 48,000 条 |
| 会议 | 600 场 |
| 委员会成员 | 200 人 |
| 审计日志 | 120,000 条 |

### 6.2 数据保留策略

| 数据类型 | 保留期限 | 说明 |
|---------|---------|------|
| 内容、发布记录 | 永久 | 物理删除时级联清理 |
| 审计日志 | 永久 | 超过 3 年可归档冷存储 |
| 密码重置 Token | 使用后立即标记失效 | 可定期清理过期记录 |

---

## 7. 技术约束

| 类别 | 约束内容 |
|------|---------|
| 编程语言 | Python 3.11+（后端），TypeScript 5.0+（前端）|
| 后端框架 | FastAPI 0.115+，SQLAlchemy 2.0，Alembic |
| 前端框架 | Vue 3.5+，Pinia，Element Plus，Vite 6 |
| 数据库 | SQLite（开发）/ PostgreSQL（生产）|
| 部署方式 | Docker Compose（Nginx + FastAPI + 可选 PostgreSQL）|
| 认证方式 | JWT，暂不支持 OAuth / SSO |
| 并发编辑 | 不支持实时协同，后保存覆盖先保存 |
| Hugo 发布 | 仅支持本地路径模式（不支持远程 SSH）|

---

## 8. 验收标准

### 8.1 认证模块

- [x] 登录、Token 过期跳转正常工作
- [x] 首次启动初始化流程，临时账号自动删除
- [x] 密码重置邮件正常发送，Token 一次性有效

### 8.2 多租户隔离

- [x] 普通用户无法访问其他社区数据（返回 403）
- [x] 切换社区后，所有列表数据自动重新加载

### 8.3 内容管理

- [x] DOCX 上传后正确提取图片并转换为 Markdown
- [x] 状态流转符合工作流规则
- [x] 内容排期日历：拖拽后 `scheduled_publish_at` 正确更新
- [x] 协作者和责任人可独立管理

### 8.4 多渠道发布

- [x] 微信发布：成功创建草稿，返回草稿 ID
- [x] Hugo 发布：在指定路径生成 `.md` 文件
- [x] CSDN / 知乎：格式内容正确生成，可一键复制

### 8.5 社区治理

- [x] 委员会成员完整信息录入，支持角色多选
- [x] 会议创建必须绑定委员会
- [x] ICS 文件可正常导入主流日历客户端

### 8.6 个人工作台

- [x] 跨社区汇总当前用户所有 assignee 任务
- [x] 内容和会议分别展示，可点击跳转

### 8.7 安全

- [x] 密码以 bcrypt 哈希形式存储
- [x] 渠道 AppSecret 加密，API 返回脱敏
- [x] 文件上传仅接受白名单格式（.docx / .md / 图片）

---

## 9. 术语表

| 术语 | 定义 |
|------|------|
| 社区（Community）| 独立的多租户数据隔离单元，对应一个开源社区 |
| 多租户（Multi-Tenancy）| 多个社区共享一套系统实例，数据行级隔离 |
| Superuser | 平台超级管理员，跨社区访问，不受 community_id 限制 |
| Admin | 社区管理员，仅可管理所属社区 |
| Owner（内容）| 内容当前所有者，拥有完整编辑权，可转让 |
| Collaborator | 内容协作编辑者，权限仅次于 owner |
| Assignee | 内容或会议的责任人，出现在个人工作台 |
| 工作流状态（status）| 内容从草稿到发布的审核流程状态 |
| 工作状态（work_status）| 独立于工作流的任务进度标记 |
| ICS | iCalendar 格式，用于导出日历事件到第三方日历工具 |
| Fernet | 对称加密算法，用于渠道凭证加密存储 |
| X-Community-Id | HTTP 请求头，客户端声明当前操作的社区 |

---

## 10. 变更记录

| 版本 | 日期 | 变更内容 |
|------|------|---------|
| v1.0 | 2025-12 | 初始版本（单租户内容管理）|
| v2.0 | 2026-02-06 | 升级多租户架构，新增日历/看板/分析/审计日志 |
| v3.0 | 2026-02-21 | 全量更新：补充委员会治理、会议管理、个人工作台、社区总览、密码重置等已交付功能；删除未实现内容；与代码实现保持同步 |

---

**文档版本**: v3.0
**维护原则**: 本文档与代码实现同步更新，每次交付新功能后同步修订。
