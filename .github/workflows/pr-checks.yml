name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  pr-metadata:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Check PR title
      run: |
        PR_TITLE="${{ github.event.pull_request.title }}"

        # Check if PR title follows conventional commits
        if ! echo "$PR_TITLE" | grep -qE '^(feat|fix|docs|style|refactor|perf|test|chore|build|ci)(\(.+\))?: .+'; then
          echo "‚ùå PR title does not follow conventional commits format"
          echo "Expected format: type(scope): description"
          echo "Types: feat, fix, docs, style, refactor, perf, test, chore, build, ci"
          exit 1
        fi

        echo "‚úÖ PR title follows conventional commits format"

    - name: Check PR size
      run: |
        # Get changed lines count
        git diff --shortstat origin/${{ github.base_ref }}...HEAD > diff_stats.txt

        INSERTIONS=$(grep -oP '\d+(?= insertion)' diff_stats.txt || echo "0")
        DELETIONS=$(grep -oP '\d+(?= deletion)' diff_stats.txt || echo "0")
        TOTAL=$((INSERTIONS + DELETIONS))

        echo "üìä Changes: +$INSERTIONS -$DELETIONS (total: $TOTAL lines)"

        # Warn if PR is too large (>1000 lines)
        if [ $TOTAL -gt 1000 ]; then
          echo "‚ö†Ô∏è This PR is quite large ($TOTAL lines). Consider splitting into smaller PRs."
        else
          echo "‚úÖ PR size is reasonable"
        fi

    - name: Check for Co-authored-by
      run: |
        # Check last commit message
        COMMIT_MSG=$(git log -1 --pretty=%B)

        if echo "$COMMIT_MSG" | grep -q "Co-Authored-By: Claude Sonnet"; then
          echo "‚úÖ Co-authored-by tag found"
        else
          echo "‚ö†Ô∏è Missing Co-authored-by tag for AI assistance"
        fi

  files-changed:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Get changed files
      id: changed-files
      uses: tj-actions/changed-files@v41
      with:
        files_yaml: |
          backend:
            - 'backend/**'
          frontend:
            - 'frontend/**'
          docs:
            - 'docs/**'
          config:
            - '*.yml'
            - '*.yaml'
            - '*.json'
            - 'Makefile'
            - 'docker-compose.yml'

    - name: Report changed areas
      run: |
        echo "## üìÅ Changed Files Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        if [ "${{ steps.changed-files.outputs.backend_any_changed }}" == "true" ]; then
          echo "- üîß Backend files changed" >> $GITHUB_STEP_SUMMARY
        fi

        if [ "${{ steps.changed-files.outputs.frontend_any_changed }}" == "true" ]; then
          echo "- üé® Frontend files changed" >> $GITHUB_STEP_SUMMARY
        fi

        if [ "${{ steps.changed-files.outputs.docs_any_changed }}" == "true" ]; then
          echo "- üìù Documentation changed" >> $GITHUB_STEP_SUMMARY
        fi

        if [ "${{ steps.changed-files.outputs.config_any_changed }}" == "true" ]; then
          echo "- ‚öôÔ∏è Configuration changed" >> $GITHUB_STEP_SUMMARY
        fi

  code-review-checklist:
    runs-on: ubuntu-latest

    steps:
    - name: Post review checklist
      uses: actions/github-script@v7
      with:
        script: |
          const checklist = `
          ## üîç Code Review Checklist

          Please ensure the following before merging:

          ### Functionality
          - [ ] Code implements the intended feature/fix
          - [ ] No breaking changes (or properly documented)
          - [ ] Error handling is appropriate
          - [ ] Edge cases are considered

          ### Code Quality
          - [ ] Code is readable and well-structured
          - [ ] No code duplication
          - [ ] Functions/classes have single responsibility
          - [ ] Variable/function names are descriptive

          ### Testing
          - [ ] Tests are included (if applicable)
          - [ ] All tests pass
          - [ ] Manual testing completed

          ### Security
          - [ ] No sensitive data hardcoded
          - [ ] Input validation present
          - [ ] SQL injection prevention (using ORM)
          - [ ] Authentication/authorization checked

          ### Documentation
          - [ ] Code comments where necessary
          - [ ] API documentation updated
          - [ ] README updated (if needed)
          - [ ] Migration instructions provided

          ### Database
          - [ ] Migration script tested
          - [ ] Backward compatibility considered
          - [ ] Indexes added for performance

          ### Performance
          - [ ] No obvious performance issues
          - [ ] Database queries optimized
          - [ ] Proper pagination for lists
          `;

          // Only post on PR open, not on every sync
          if (context.payload.action === 'opened') {
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: checklist
            });
          }
